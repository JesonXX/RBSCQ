<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>审计部工作日报生成器</title>
    <style>
        body {
            font-family: 'FangSong', '仿宋', 'Fangsong', serif;
            font-size: 12pt;
            line-height: 1.4;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            color: black;
        }
        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            box-sizing: border-box;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .title {
            font-family: 'FangSong', '仿宋', serif;
            font-size: 16pt;
            font-weight: bold;
            color: red;
            text-align: center;
            margin-bottom: 10mm;
        }
        .subtitle-line {
            border-bottom: 1px solid black;
            padding-bottom: 2mm;
            margin-top: -2mm;
        }
        .group-date {
            display: flex;
            justify-content: space-between;
            font-size: 12pt;
            margin-bottom: 5mm;
        }
        .section {
            font-size: 12pt;
            margin: 15mm 0 5mm 0;
        }
        .list-item ol {
            margin: 0;
            padding-left: 2em;
            list-style: decimal;
        }
        .list-item li {
            margin-bottom: 8mm;
            line-height: 1.4;
            padding-left: 0.5em;
        }
        .page-number {
            position: fixed;
            bottom: 20mm;
            right: 20mm;
            font-size: 10pt;
            color: #808080;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group textarea, .form-group input:not([type=date]) {
            width: 100%;
            font-family: 'FangSong', '仿宋', serif;
            font-size: 12pt;
            padding: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .generate-btn, .pdf-btn {
            background: #007bff; color: white; padding: 12px 25px; border: none; cursor: pointer;
            font-size: 14pt; margin: 10px 10px 10px 0; border-radius: 4px;
        }
        .generate-btn:hover, .pdf-btn:hover { background: #0056b3; }
        .preview { margin-top: 30px; border: 1px dashed #aaa; padding: 20mm; position: relative; }
        @media print {
            body * { visibility: hidden; }
            .preview, .preview * { visibility: visible; }
            .preview { position: absolute; left: 0; top: 0; width: 100%; border: none; }
            .generate-btn, .pdf-btn, .form-group { display: none; }
        }
    </style>
    <!-- 升级到最新稳定版 html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js" integrity="sha512-Ib3ocB5Lm/0sMwe4i4/0a+0i3p0S/0tOwx5cX0i0u/6Qb8R2x4u7mZvQ1qB6G+9e1pK2qAD2N8w0r4Gq9L0/7aG8tXRA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <h2>审计部工作日报生成器</h2>
        
        <div class="form-group">
            <label>小组名称：</label>
            <input type="text" id="group" value="现场审计12组">
        </div>
        
        <div class="form-group">
            <label>日期（自动今日）：</label>
            <input type="date" id="date">
        </div>
        
        <div class="form-group">
            <label>今日工作（每段一行，支持手动换行）：</label>
            <textarea id="content" rows="10">1.对盘山支行开展资产分类审计，复核审计工作底稿，
整理审计档案资料，交回调阅的审计资料。

2.对盘锦中心支行开展案件防控审计，复核审计工作底稿，
整理审计档案资料，交回调阅的审计资料。

3.按照审计团队工作要求，梳理阜新海州支行、阜新支行和营口鲅鱼圈支行全面审计中违规问题划分情况。</textarea>
        </div>
        
        <button class="generate-btn" onclick="generateReport()">生成预览</button>
        <button class="pdf-btn" onclick="downloadPDF()" style="display:none;" id="pdfBtn">下载PDF（已修复空白问题）</button>
        
        <div class="preview" id="preview" style="display:none;">
            <div class="title">审计部工作日报</div>
            <div style="text-align:center; font-size:12pt;">
                <div class="group-date">
                    <span id="reportGroup">现场审计12组</span>
                    <span id="reportDate">2025年11月7日</span>
                </div>
                <div class="subtitle-line"></div>
            </div>
            <div class="section">一、 今日工作</div>
            <div class="list-item" id="reportContent"></div>
            <div class="page-number">- 1 -</div>
        </div>
    </div>

    <script>
        // 自动填充今天日期（2025-11-10）
        window.onload = function() {
            document.getElementById('date').value = '2025-11-10';
        };

        function generateReport() {
            const group = document.getElementById('group').value.trim();
            const dateInput = document.getElementById('date').value;
            const date = new Date(dateInput);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const chineseDate = `${year}年${month}月${day}日`;

            document.getElementById('reportGroup').textContent = group;
            document.getElementById('reportDate').textContent = chineseDate;

            // 自动处理编号与换行
            const raw = document.getElementById('content').value;
            const lines = raw.split('\n').filter(l => l.trim());
            let html = '<ol>';
            lines.forEach(line => {
                const clean = line.replace(/^\d+\.?\s*/, '').trim();
                html += `<li>${clean}</li>`;
            });
            html += '</ol>';
            document.getElementById('reportContent').innerHTML = html;

            document.getElementById('preview').style.display = 'block';
            document.getElementById('pdfBtn').style.display = 'inline-block';
        }

        function downloadPDF() {
            const element = document.getElementById('preview');
            
            // 关键修复：先强制重绘，再延迟生成
            element.style.display = 'none';
            element.offsetHeight; // 触发重绘
            element.style.display = 'block';

            setTimeout(() => {
                const opt = {
                    margin: [15, 10, 15, 10],
                    filename: `审计部工作日报-${document.getElementById('date').value}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                html2pdf().set(opt).from(element).save()
                    .then(() => console.log('PDF生成成功'))
                    .catch(err => alert('生成失败：' + err.message));
            }, 300);
        }
    </script>
</body>
</html>
